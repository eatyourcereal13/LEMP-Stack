# LEMP Stack в Docker

Простой контейнер с LEMP стеком (RockyLinux, Nginx, PHP-FPM, MariaDB), который показывает данные из базы на главной странице и метрики Nginx.

## Что внутри

**LEMP Stack:**
- **Linux:** Rocky Linux 9 (RPM-based)
- **Nginx:** Веб-сервер с метриками
- **PHP-FPM:** Обработчик PHP скриптов  
- **MariaDB:** База данных с тестовыми данными

**Что делает:**
- Главная страница выводит 2 строки из базы данных
- `/metrics` - отдает метрики Nginx в формате stub_status
- Автоматически инициализирует БД при первом запуске

## Быстрый старт

```bash
# Собрать образ
docker build -t rocky .

# Запустить контейнер
docker run -d -p 8080:80 --name lemp rocky
```

Или через Makefile:
```bash
make build  # Собрать
make up     # Запустить
make test   # Проверить
```

## Что проверять

1. **Главная страница:** http://localhost:8080/
   ```
   Привет
   Мир
   ```

2. **Метрики Nginx:** http://localhost:8080/metrics
   ```
   Active connections: 2
   server accepts handled requests
    10 10 15
   Reading: 0 Writing: 1 Waiting: 1
   ```

## Про метрики Nginx

Что означают цифры на `/metrics`:

- **Active connections:** сколько сейчас соединений активно
- **Accepts:** сколько всего соединений принял сервер
- **Handled:** сколько соединений обработал (должно = Accepts)
- **Requests:** сколько HTTP запросов обработал
- **Reading:** соединения читают заголовки запроса
- **Writing:** соединения отправляют ответ
- **Waiting:** соединения в режиме ожидания

## CI/CD автоматизация

В проекте настроен GitHub Actions пайплайн (`.github/workflows/docker.yml`), который при каждом пуше в main:

1. Автоматически собирает Docker образ
2. Запускает контейнер
3. Проверяет что:
   - Главная страница доступна
   - Метрики Nginx работают
   - Данные из БД отображаются

Это гарантирует, что любой код, который попадает в основную ветку, проходит базовые тесты.

## Структура файлов

```
.
├── Dockerfile     # Описание контейнера
├── init.sh       # Скрипт запуска всех сервисов
├── nginx.conf    # Конфиг Nginx с метриками
├── index.php     # Главная страница (PHP + БД)
├── init.sql      # Настройка БД и тестовые данные
├── Makefile      # Команды для удобства
└── .github/workflows/docker.yml  # CI/CD пайплайн
```

## Если что-то не работает

```bash
# Смотреть логи
make logs

# Проверить процессы в контейнере
docker exec lemp ps aux

# Зайти внутрь контейнера
docker exec -it lemp bash
```

## Особенности реализации

- **Всё в одном контейнере**
- **Автоматическое создание БД**
- **Встроенные Nginx метрики**
- **Готово к работе:** запустил и пользуйся

---

**Для разработчиков:** если хочется поменять пароль БД или добавить свои данные - править в `init.sql` и `index.php`.
**Было принято решение не выносить меняемые данные в .env, тк решил, что это избыточно. В реальной реализации вынести 100%**